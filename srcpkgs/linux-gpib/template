# Template file for 'linux-gpib'
pkgname=linux-gpib
version=4.3.6
revision=1
# musl does not define PTHREAD_ADAPTIVE_MUTEX_INITIALIZER_NP
archs="~*-musl"
hostmakedepends="rsync"
depends="dkms"
short_desc="GPIB kernel modules and userspace utilities"
maintainer="Adam Gausmann <adam@gaussian.dev>"
license="GPL-3.0-or-later"
homepage="https://sourceforge.net/projects/linux-gpib"
changelog="https://sourceforge.net/p/linux-gpib/code/HEAD/tree/trunk/ChangeLog?format=raw"
distfiles="https://sourceforge.net/projects/linux-gpib/files/linux-gpib%20for%203.x.x%20and%202.6.x%20kernels/${version}/linux-gpib-${version}.tar.gz"
checksum=1b37b8c6bbe4844827f89e4986bc9c7b38e9dae8650f5bfa697d161afe09d898
make_dirs="/usr/share/usb 0755 root root
 /usr/share/usb/ni_usb_gpib 0755 root root
 /usr/share/usb/agilent_82357a 0755 root root"
dkms_modules="${pkgname} ${version}"

post_extract() {
	bsdtar -xf "linux-gpib-kernel-${version}.tar.gz"
	bsdtar -xf "linux-gpib-user-${version}.tar.gz"
}

do_build() {
	cd "linux-gpib-user-${version}"
	./configure --host=${XBPS_CROSS_TRIPLET} --prefix=/usr \
		--sbindir=/usr/bin --sysconfdir=/etc
	make ${makejobs}
}

do_install() {
	vmkdir usr/src
	rsync -a "linux-gpib-kernel-${version}/" "${DESTDIR}/usr/src/${pkgname}-${version}"
	vinstall "${FILESDIR}/dkms.conf" 644 "usr/src/${pkgname}-${version}"

	cd "linux-gpib-user-${version}"
	make "DESTDIR=${DESTDIR}" UDEV_RULES_DIR=/usr/lib/udev/rules.d install
	vdoc AUTHORS
	vdoc COPYING
	vdoc ChangeLog
	vdoc README
	vdoc README.HAMEG
	vdoc README.hp82335
	vdoc TODO
}
